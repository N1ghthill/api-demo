name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Typecheck and tests
        run: npm run check

      - name: OpenAPI lint
        run: npm run docs:openapi

  smoke-docker:
    runs-on: ubuntu-latest
    needs: checks
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Docker smoke test (db + api)
        shell: bash
        run: |
          set -euo pipefail
          docker compose up -d db

          for i in {1..40}; do
            if docker compose exec -T db pg_isready -U demo -d enrollment_demo >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          DATABASE_URL=postgres://demo:demo@127.0.0.1:5432/enrollment_demo PORT=3005 node dist/server.js >/tmp/api-demo.log 2>&1 &
          APP_PID=$!
          trap 'kill $APP_PID 2>/dev/null || true; docker compose down -v' EXIT

          sleep 2
          curl -fsS http://127.0.0.1:3005/api/health | grep -q '"ok":true'
          curl -fsS http://127.0.0.1:3005/api/courses | grep -q '"courses"'
